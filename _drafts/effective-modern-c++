---
layout: post
title: effective modern c++
categories: dev
tags: c++
---

# auto 타입 추론 규칙

 - auto의 타입 추론은 한가지 예외를 빼면 템플릿 타입 추론 규칙이 auto의 타입 추론 규칙이다.

```c++
template<typananem T>
void f(ParamType param);	// ParamType 은 매개변수 param의 타입

f(expr);			// expr 은 인수의 타입을 결정한다.
```

 - f를 호출할 때 컴파일러는 expr을 이용해서 T의 형식과 ParamType의 형식을 추론한다.
 - auto 를 이용해서 변수를 선언 할 때 auto는 템플릿의 T와 동일한 역할을 하고, 변수의 형식 지정자가 ParamType의 역할을 한다. 
 
```c++
auto x = 27;		// auto는 T
const auto cx = x;	// const auto 는 const T 와 같은 매개변수 타입 ParamType
const auto& rx = x;	// const auto& 는 const T& 와 같은 매개변수 타입 ParamType
```

 - auto 는 uniform initialization 에서 의미가 달라진다.

```c++
// 모두 27 을 값으로 가지는 int
int x1 = 27;
int x2(27);
int x3 = { 27 };
int x4{ 27 };
```

```c++
auto x1 = 27;		// int x1 = 27;
auto x2(27);		// int x2(27);
auto x3 = { 27 };	// std::initializer_list<int> x3 = { 27 };
auto x4{ 27 };		// std::initializer_list<int> x4{ 27 }; c++11, c++14까지.. 이후에는 int x4{ 27 };
```

 - 템플릿은 uniform initialization 을 추론하지 못한다. 
 
```c++
auto x = { 11, 23, 9 };	// std::initializer_list<int> x = { 11, 23, 9 };
 
template<typename T>
void f(T param);
 
f({ 11, 23, 9 });		// T를 추론할 수 없음. 오류
```

 - C++14 에서는 반환 타입을 auto로 지정해서 컴파일러가 추론할 수 있다.
 - C++14 에서는 람다의 매개변수 선언에 auto를 사용할 수 있다.
 - C++14 에서의 반환 타입 auto 와 람다의 매개변수 선언 auto는 템플릿 추론 규칙이 적용된다.
 
```c++
auto create_init_list()
{
	return { 1, 2, 3 };	// 템플릿 추론 규칙으로 추론 실패.
}

std::vector<int> v;

auto reset_v = [&v](const auto& new_value) { v = new_value; };	// C++14

reset_v({ 1, 2, 3 });
```

---
layout: post
title: baidu push c# 구현
categories: dev
tags: baidu push c# dev
---
# reference
- [http://push.baidu.com/doc/restapi/restapi](http://push.baidu.com/doc/restapi/sdk_developer)
- [http://push.baidu.com/doc/restapi/sdk_developer](http://push.baidu.com/doc/restapi/sdk_developer)

# 유의할 점
- baidu 의 push server 가 php 로 구현되어있는지 php 의 urlencode 를 구현해야 한다. php 의 urlencode 는 공백(%20)을 '+' 로 대체한다. 

```c#
TimeSpan t = DateTime.Now - new DateTime(1970, 1, 1);
int totalSeconds = (int)t.TotalSeconds;
string timestamp = totalSeconds.ToString();                

SortedDictionary<string, string> param = new SortedDictionary<string, string>();
param["apikey"] = _setting.ApiKey;
param["timestamp"] = timestamp;
param["channel_id"] = baiduNotification.ChannelId;
param["msg"] = baiduNotification.Msg;

if (baiduNotification.MsgType.HasValue)
{
	param["msg_type"] = baiduNotification.MsgType.Value.ToString();
}

if (baiduNotification.DeployStatus.HasValue)
{
	param["deploy_status"] = baiduNotification.DeployStatus.Value.ToString();
}                

string parameterString = "";

foreach (KeyValuePair<string, string> pair in param)
{
	parameterString += pair.Key + "=" + pair.Value;
}

string baseString = _setting.Method + _setting.Url + parameterString + _setting.SecretKey;

string escapedDataString = Uri.EscapeDataString(baseString);
string urlencodedString = escapedDataString.Replace("%20", "+");

string hashedString = "";
using (MD5 md5 = MD5.Create())
{
	byte[] data = md5.ComputeHash(Encoding.UTF8.GetBytes(urlencodedString));

	StringBuilder builder = new StringBuilder();

	for (int i = 0; i < data.Length; ++i)
	{
		builder.Append(data[i].ToString("x2"));
	}

	hashedString = builder.ToString();
}

param["sign"] = hashedString;

string content = "";                
foreach (KeyValuePair<string, string> pair in param)
{
	if (0 < content.Length)
		content += "&";

	content += pair.Key + "=" + pair.Value;
}

HttpClient client = new HttpClient();                    
client.DefaultRequestHeaders.UserAgent.TryParseAdd("BCCS_SDK/3.0 (Darwin; Darwin Kernel Version 14.0.0: Fri Sep 19 00:26:44 PDT 2014; root:xnu-2782.1.97~2/RELEASE_X86_64; x86_64) PHP/5.6.3 (Baidu Push Server SDK V3.0.0 and so on..) cli/Unknown ZEND/2.6.0");

StringContent stringContent = new StringContent(content, Encoding.UTF8, "application/x-www-form-urlencoded");
Httpㅐㅑㅇ
  ```
# auto 타입 추론 규칙
# decltype 작동 방식
# constexpr 
# 특수 멤버 함수들의 자동 작성 조건
# std::move 와 std::forward
# 참조 축약
# 완벽 전달의 실패

# reference
- [http://push.baidu.com/doc/restapi/restapi](http://push.baidu.com/doc/restapi/sdk_developer)
- [http://push.baidu.com/doc/restapi/sdk_developer](http://push.baidu.com/doc/restapi/sdk_developer)

# 유의할 점
- baidu 의 push server 가 php 로 구현되어있는지 php 의 urlencode 를 구현해야 한다. php 의 urlencode 는 공백(%20)을 '+' 로 대체한다. 

```c#
TimeSpan t = DateTime.Now - new DateTime(1970, 1, 1);
int totalSeconds = (int)t.TotalSeconds;
string timestamp = totalSeconds.ToString();                

SortedDictionary<string, string> param = new SortedDictionary<string, string>();
param["apikey"] = _setting.ApiKey;
param["timestamp"] = timestamp;
param["channel_id"] = baiduNotification.ChannelId;
param["msg"] = baiduNotification.Msg;

if (baiduNotification.MsgType.HasValue)
{
	param["msg_type"] = baiduNotification.MsgType.Value.ToString();
}

if (baiduNotification.DeployStatus.HasValue)
{
	param["deploy_status"] = baiduNotification.DeployStatus.Value.ToString();
}                

string parameterString = "";

foreach (KeyValuePair<string, string> pair in param)
{
	parameterString += pair.Key + "=" + pair.Value;
}

string baseString = _setting.Method + _setting.Url + parameterString + _setting.SecretKey;

string escapedDataString = Uri.EscapeDataString(baseString);
string urlencodedString = escapedDataString.Replace("%20", "+");

string hashedString = "";
using (MD5 md5 = MD5.Create())
{
	byte[] data = md5.ComputeHash(Encoding.UTF8.GetBytes(urlencodedString));

	StringBuilder builder = new StringBuilder();

	for (int i = 0; i < data.Length; ++i)
	{
		builder.Append(data[i].ToString("x2"));
	}

	hashedString = builder.ToString();
}

param["sign"] = hashedString;

string content = "";                
foreach (KeyValuePair<string, string> pair in param)
{
	if (0 < content.Length)
		content += "&";

	content += pair.Key + "=" + pair.Value;
}

HttpClient client = new HttpClient();                    
client.DefaultRequestHeaders.UserAgent.TryParseAdd("BCCS_SDK/3.0 (Darwin; Darwin Kernel Version 14.0.0: Fri Sep 19 00:26:44 PDT 2014; root:xnu-2782.1.97~2/RELEASE_X86_64; x86_64) PHP/5.6.3 (Baidu Push Server SDK V3.0.0 and so on..) cli/Unknown ZEND/2.6.0");

StringContent stringContent = new StringContent(content, Encoding.UTF8, "application/x-www-form-urlencoded");
HttpResponseMessage response = client.PostAsync(_setting.Url, stringContent).Result;
```
